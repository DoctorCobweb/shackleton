define(["backbone","braintree","text!tpl/CreditCardDetailsView.html","views/checkout-view","text!tpl/SuccessfulUserFeedback.html","text!tpl/NegativeUserFeedback.html","cookie_util"],function(e,t,n,r,i,s,o){var u=e.View.extend({tagName:"div",className:"view_credit_card_details",template:_.template(n),events:{"keypress #cc_number":"cc_number_update","keypress #cc_cvv":"cc_cvv_update","keypress #cc_month":"cc_month_update","keypress #cc_year":"cc_year_update","blur #cc_number":"cc_number_blur","blur #cc_cvv":"cc_cvv_blur","blur #cc_month":"cc_month_blur","blur #cc_year":"cc_year_blur","click #submit_new_cc":"submit_new_cc","click #submit_order":"submit_order","click #during_checkout_edit_cc_details":"edit_vault_cc","mouseover #submit_new_cc":"select_proceed","mouseout  #submit_new_cc":"deselect_proceed","mouseover #submit_order":"select_proceed","mouseout  #submit_order":"deselect_proceed","mouseover #during_checkout_edit_cc_details":"select_proceed","mouseout  #during_checkout_edit_cc_details":"deselect_proceed"},select_proceed:function(e){this.$("#"+e.currentTarget.id).css("background-color","#1D883B")},deselect_proceed:function(e){this.$("#"+e.currentTarget.id).css("background-color","#2BBB53")},initialize:function(){console.log("in initialize() of credit-card-details-view.js"),this.current_view=this,this.field_to_set={},_.bindAll(this),this.braintree=t.create("MIIBCgKCAQEAwJo0HGLwcnHbj+LCBWEvxjjfZYTwoJuNvR34CevWwu71HeQ7s6kD9FuzK3nHFL0oA2/HchnhmWh4ilFzYq3/4U+hNLJwdG++MlZxQ9KlfLX2ROatmuOyIcD1mXKlKAEhuxU4OnTBnMByyzhy3Hz/9omOGWK0bjmSKkZabjwiqgs0E2VLeRaTERxWPPAKEPgKfiFjiYdOyYbXvvOtRU6kMze6ZoYnF098/RkrJuL8a+tn6otmQHJOvvLobJf0PYTH1YKEgx7JGhTQ0tvewd/gz4Lg8GMknM0HkGWaqtpLzeqahDGfik0PZQfWArvVQofOLVito0yY1Ck6G2A8mrjb/QIDAQAB"),console.log("braintree object:"),console.dir(this.braintree)},render:function(){console.log("in credit-card-details-view.js and render()"),this.$el.html(this.template(this.model.toJSON()));var e=this.model.get("number_of_tickets")*this.model.get("ticket_price");return this.$("#summary_total_amount").html(e),this.$cc_number=this.$("#cc_number"),this.$cc_cvv=this.$("#cc_cvv"),this.$cc_month=this.$("#cc_month"),this.$cc_year=this.$("#cc_year"),this},cc_number_update:function(e){console.log("cc_number");return},cc_cvv_update:function(e){console.log("cc_cvv");return},cc_month_update:function(e){console.log("cc_month");return},cc_year_update:function(e){console.log("cc_year");return},cc_number_blur:function(e){console.log("cc_number_blur"),this.close_input_field(this.$cc_number,"cc_number");return},cc_cvv_blur:function(e){console.log("cc_cvv_blur"),this.close_input_field(this.$cc_cvv,"cc_cvv");return},cc_month_blur:function(e){console.log("cc_month_blur"),this.close_input_field(this.$cc_month,"cc_month");return},cc_year_blur:function(e){console.log("cc_year_blur"),this.close_input_field(this.$cc_year,"cc_year");return},close_input_field:function(e,t){console.log("close_input_field()"),console.dir(e),console.log("model_attribute: "+t);var n=e.val().trim(),r=this.braintree.encrypt(n);this.field_to_set[t]=r,this.model.set(this.field_to_set),console.log("value entered into field, "+t+" is "+n),console.log("encrpyted value of entered into field, "+t+" is "+r);return},edit_vault_cc:function(){this.$cc_number.val(""),this.$cc_cvv.val(""),this.$cc_month.val(""),this.$cc_year.val(""),this.$("#vault_cc").css("display","none"),this.$("#submit_order").css("display","none"),this.$("#during_checkout_new_credit_card_details").css("display","block")},submit_new_cc:function(){console.log("submitting new cc details for verification"),console.log("this.model: "),console.dir(this.model);var e=this;if(!o.get("reserve_tickets")){console.log("cannot submit order because cookie timedout"),alert("TICKET RESERVATION EXPIRED: Please start again.");return}var t=e.$("#vault_cc > .successful_user_feedback");t.css("display")=="block"&&t.css("display","none"),$.ajax({url:"/api/users/change_cc_details/",type:"POST",data:e.field_to_set,success:function(t,n,r){console.log("SUCCESS: submitted new cc details"),console.dir(t),console.log(n),console.dir(r);if(!t.success){e.render(),e.$("#during_checkout_new_credit_card_details").prepend(_.template(s)({error:"could not save/verify credit card. Try again."}));return}e.$("#during_checkout_new_credit_card_details").css("display","none"),e.$("#vault_cc").css("display","block"),e.$("#vault_cc > #cc_masked_number").html(t.result.masked_number),e.$("#vault_cc > #cc_expiration_date").html(t.result.expiration_date),e.$("#submit_order").css("display","block"),e.$("#vault_cc").prepend(_.template(i)({success:"Updated credit card"}))},error:function(t,n,r){console.log("ERROR: in submitting new cc details"),console.dir(t),console.log(n),console.dir(r),e.render();return}})},submit_order:function(){console.log("in submit_order function");var e=this;if(!o.get("reserve_tickets")){alert("YOUR TICKET RESERVATION HAS EXPIRED: Please start again.");return}this.model.save({},{success:function(t,n){console.log("SUCCESS in saving/updating the model => order has been made"),console.dir(t),console.dir(n);if(n.errors){console.log("ERRORS: we have errors in processing the order");if(!_.isEmpty(n.errors.validation_errors)){console.log("VALIDATION_ERROR: data posted created validation errors"),e.render();return}if(!_.isEmpty(n.errors.internal_errors)){console.log("INTERNAL_ERROR: data posted created internal errors"),alert("ERROR: there was a problem submitting your order: "+n.errors.internal_errors.error),e.render();return}return}e.handle_cc_statuses(n,t)},error:function(t,n){console.log("ERROR in saving/updating the model"),console.dir(t),console.dir(n),e.render()}})},handle_cc_statuses:function(t,n){var i=t.transaction_status;if(i==="submitted_for_settlement"){console.log("transaction_status: "+i),e.trigger("order:finished"),clearInterval(this.interval_id);var s=new r({model:n});this.show_view("#featureContent",s),window.scrollTo(0,350)}else i==="authorized"?console.log("transaction_status: "+i):console.log("transaction_status: "+i)},show_view:function(e,t){return console.log("in showView of credit-card-details-view.js"),this.current_view&&this.current_view.close(),$(e).html(t.render().el),this.current_view=t,t}});return u});